<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Trading Cripto - Suite Completa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 20px;
            min-height: 100vh;
            color: #e4e4e7;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #1e1e2e;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: visible;
            border: 1px solid #2d2d44;
        }

        .header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 15px 15px 0 0;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.95;
            font-size: 14px;
        }

        /* TABS */
        .tabs-container {
            display: flex;
            background: #252538;
            border-bottom: 2px solid #3d3d5c;
        }

        .tab {
            flex: 1;
            padding: 18px 30px;
            text-align: center;
            cursor: pointer;
            background: #252538;
            color: #a1a1aa;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s;
            border-right: 1px solid #3d3d5c;
            position: relative;
        }

        .tab:last-child {
            border-right: none;
        }

        .tab:hover {
            background: #2d2d44;
            color: #d4d4d8;
        }

        .tab.active {
            background: #1e1e2e;
            color: #a78bfa;
            border-bottom: 3px solid #6366f1;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* FAB para calculadora clásica flotante */
        .fab-calculator {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.5);
            transition: all 0.3s;
            z-index: 999;
            border: none;
            color: white;
            font-size: 24px;
        }

        .fab-calculator:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(245, 158, 11, 0.7);
        }

        /* FAB Historial */
        .fab-history {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.5);
            transition: all 0.3s;
            z-index: 1000;
            border: none;
            color: white;
            font-size: 24px;
        }

        .fab-history:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(99, 102, 241, 0.7);
        }

        .fab-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
        }

        /* Modal flotante para calculadora clásica */
        .floating-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d3748;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9);
            z-index: 2500;
            display: none;
            border: 2px solid #f59e0b;
            max-width: 600px;
            width: 90%;
        }

        .floating-modal.show {
            display: block;
            animation: modalSlideIn 0.3s;
        }

        @keyframes modalSlideIn {
            from { transform: translate(-50%, -60%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }

        .floating-modal-header {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 13px 13px 0 0;
            cursor: move;
        }

        .floating-modal-header h3 {
            font-size: 20px;
            margin: 0;
        }

        .btn-close-floating {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-close-floating:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .floating-modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: none;
        }

        .modal-backdrop.show {
            display: block;
        }

        /* CALCULADORA CLÁSICA STYLES */
        .classic-calc-container {
            background: #374151;
            border-radius: 10px;
            padding: 25px;
        }

        .classic-calc-container h2 {
            color: #fbbf24;
            margin-bottom: 20px;
            font-size: 24px;
            text-align: center;
        }

        .classic-input-group {
            margin-bottom: 15px;
        }

        .classic-input-group label {
            display: block;
            color: #d1d5db;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .classic-input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #4b5563;
            border-radius: 6px;
            font-size: 14px;
            background: #1f2937;
            color: #e5e7eb;
        }

        .classic-input-group input:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }

        .classic-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .classic-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.5);
        }

        .classic-results {
            margin-top: 20px;
            padding: 20px;
            background: #1f2937;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }

        .classic-result-item {
            margin: 10px 0;
            font-size: 14px;
        }

        .classic-result-item strong {
            color: #fbbf24;
        }

        .classic-result-value {
            color: #e5e7eb;
            font-weight: 600;
        }

        .classic-result-green {
            color: #22c55e;
        }

        .classic-result-red {
            color: #ef4444;
        }

        .classic-result-yellow {
            color: #fbbf24;
        }

        /* Estilos de la calculadora avanzada (ya existentes) */
        .content {
            /* padding ya definido en tab-content */
        }

        .section {
            background: #252538;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #3d3d5c;
        }

        .section h2 {
            color: #a78bfa;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #6366f1;
            padding-bottom: 10px;
        }

        .history-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        }

        .history-modal.show {
            display: flex;
        }

        .history-modal-content {
            background: #1e1e2e;
            border-radius: 15px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9);
            border: 1px solid #3d3d5c;
        }

        .history-modal-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-modal-header h2 {
            font-size: 22px;
            margin: 0;
        }

        .btn-close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-close-modal:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .history-modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .history-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .history-card {
            background: #1e1e2e;
            border: 2px solid #3d3d5c;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .history-card:hover {
            border-color: #6366f1;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .history-card.selected {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-title {
            color: #a78bfa;
            font-size: 14px;
            font-weight: 600;
        }

        .history-coin {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .history-time {
            color: #71717a;
            font-size: 11px;
            margin-top: 4px;
        }

        .history-details {
            display: grid;
            gap: 8px;
            margin-top: 10px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #d4d4d8;
        }

        .history-item .label {
            color: #a1a1aa;
        }

        .history-item .value {
            font-weight: 600;
            color: #e4e4e7;
        }

        .history-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #3d3d5c;
        }

        .btn-mini {
            flex: 1;
            background: #3d3d5c;
            color: #d4d4d8;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-mini:hover {
            background: #52525b;
        }

        .btn-mini.load {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .btn-mini.delete {
            background: #7f1d1d;
            color: #fca5a5;
        }

        .btn-mini.delete:hover {
            background: #991b1b;
        }

        .compare-section {
            background: #252538;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #8b5cf6;
        }

        .compare-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .compare-card {
            background: #1e1e2e;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #6366f1;
        }

        .compare-card h4 {
            color: #a78bfa;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .compare-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .compare-item .label {
            color: #a1a1aa;
        }

        .compare-item .value {
            font-weight: 600;
            color: #e4e4e7;
        }

        .winner-indicator {
            display: inline-block;
            background: #22c55e;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 6px;
        }

        .input-group {
            margin-bottom: 15px;
            position: relative;
        }

        label {
            display: block;
            color: #d4d4d8;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
            position: relative;
            display: inline-block;
        }

        .label-with-tooltip {
            position: relative;
            cursor: help;
        }

        .label-tooltip {
            visibility: hidden;
            width: 280px;
            background-color: rgba(30, 30, 46, 0.98);
            color: #e4e4e7;
            text-align: center;
            border-radius: 8px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 0;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            font-size: 12px;
            font-weight: normal;
            line-height: 1.4;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 1px solid #6366f1;
        }

        .label-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 20px;
            border-width: 5px;
            border-style: solid;
            border-color: #6366f1 transparent transparent transparent;
        }

        .label-with-tooltip:hover .label-tooltip {
            visibility: visible;
            opacity: 1;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #3d3d5c;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: #1a1a2e;
            color: #e4e4e7;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .entries-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .entry-card {
            background: #1e1e2e;
            border: 2px solid #6366f1;
            border-radius: 10px;
            padding: 15px;
            position: relative;
        }

        .entry-card h3 {
            color: #a78bfa;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.5);
        }

        .btn-secondary {
            background: #52525b;
        }

        .btn-secondary:hover {
            background: #71717a;
            box-shadow: 0 5px 20px rgba(82, 82, 91, 0.5);
        }

        .custom-percentages {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: #1e1e2e;
            border-radius: 8px;
            border: 1px solid #3d3d5c;
        }

        .custom-percentages label {
            font-size: 12px;
            color: #a1a1aa;
        }

        .custom-percentages input {
            padding: 8px;
            font-size: 13px;
        }

        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .result-card {
            background: #1e1e2e;
            border-left: 4px solid #6366f1;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 1px solid #3d3d5c;
        }

        .result-card.optimal {
            border-left: 4px solid #8b5cf6;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);
        }

        .result-card.loss-card {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%);
        }

        .result-card h3 {
            color: #a78bfa;
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .result-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #e4e4e7;
        }

        .result-card .value.loss-value {
            color: #ef4444;
        }

        .result-card .subvalue {
            font-size: 12px;
            color: #a1a1aa;
            margin-top: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #1e1e2e;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        th {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }

        .tooltip-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .tooltip-text {
            visibility: hidden;
            width: 320px;
            background-color: rgba(30, 30, 46, 0.98);
            color: #e4e4e7;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: fixed;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            font-size: 13px;
            font-weight: normal;
            line-height: 1.5;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            pointer-events: none;
            border: 1px solid #6366f1;
        }

        .tooltip-wrapper:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #3d3d5c;
            font-size: 13px;
            color: #d4d4d8;
        }

        tr:hover {
            background: #252538;
        }

        .profit {
            color: #22c55e;
            font-weight: bold;
        }

        .loss {
            color: #ef4444;
            font-weight: bold;
        }

        .row-excellent {
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.05) 100%) !important;
            border-left: 3px solid #22c55e;
        }

        .row-good {
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.08) 0%, rgba(34, 197, 94, 0.02) 100%) !important;
        }

        .row-danger-zone {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%) !important;
            border-left: 3px solid #ef4444;
        }

        .row-critical {
            background: linear-gradient(90deg, rgba(220, 38, 38, 0.25) 0%, rgba(220, 38, 38, 0.1) 100%) !important;
            border-left: 4px solid #dc2626;
            animation: pulse-critical 2s infinite;
        }

        @keyframes pulse-critical {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .zone-indicator {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .zone-safe {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .zone-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .warning {
            background: #422006;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            color: #fbbf24;
            border: 1px solid #78350f;
        }

        .alert {
            background: #450a0a;
            border-left: 4px solid #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            color: #fca5a5;
            border: 1px solid #7f1d1d;
        }

        .collapsible-info {
            background: #164e63;
            border-left: 4px solid #06b6d4;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            border: 1px solid #0e7490;
        }

        .collapsible-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #67e8f9;
            font-weight: 600;
            user-select: none;
        }

        .collapsible-header:hover {
            background: rgba(6, 182, 212, 0.1);
        }

        .collapsible-header .arrow {
            transition: transform 0.3s;
            font-size: 18px;
        }

        .collapsible-header.active .arrow {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 15px;
            color: #a5f3fc;
            font-size: 13px;
        }

        .collapsible-content.show {
            max-height: 500px;
            padding: 0 15px 15px 15px;
        }

        .custom-row {
            background: #2d2d44 !important;
            border-left: 3px solid #8b5cf6;
        }

        .empty-history {
            text-align: center;
            padding: 40px;
            color: #71717a;
        }

        .empty-history-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .entries-container {
                grid-template-columns: 1fr;
            }

            .results {
                grid-template-columns: 1fr;
            }

            .custom-percentages {
                grid-template-columns: 1fr;
            }

            .history-container {
                grid-template-columns: 1fr;
            }

            .compare-grid {
                grid-template-columns: 1fr;
            }

            .fab-history, .fab-calculator {
                width: 56px;
                height: 56px;
            }

            .fab-calculator {
                bottom: 90px;
                right: 20px;
            }

            .fab-history {
                bottom: 20px;
                right: 20px;
            }
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a2e;
        }

        ::-webkit-scrollbar-thumb {
            background: #6366f1;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #8b5cf6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Suite de Calculadoras de Trading Cripto</h1>
            <p>Herramientas avanzadas para gestionar tus posiciones apalancadas</p>
        </div>

        <!-- TABS -->
        <div class="tabs-container">
            <div class="tab active" onclick="switchTab('advanced')">
                🚀 Calculadora Avanzada
            </div>
            <div class="tab" onclick="switchTab('classic')">
                📐 Calculadora Clásica SL V3
            </div>
        </div>

        <!-- TAB CONTENT: CALCULADORA AVANZADA -->
        <div id="advanced-tab" class="tab-content active">

            <div class="section">
                <h2>⚙️ Configuración General</h2>
                <div class="input-group">
                    <label>Nombre de la Moneda</label>
                    <input type="text" id="coin-name" placeholder="Ej: BTC, ETH, SOL..." value="BTC" style="text-transform: uppercase;">
                </div>
                <div class="input-group">
                    <label>Apalancamiento (x)</label>
                    <input type="number" id="leverage" value="10" min="1" max="125" step="1">
                </div>
                <div class="input-group">
                    <label class="label-with-tooltip">
                        Stop Loss (%)
                        <span class="label-tooltip">Distancia del precio de entrada</span>
                    </label>
                    <input type="number" id="stop-loss-percent" value="5" min="0" max="100" step="1">
                </div>
                <div class="input-group">
                    <label>Dirección de Posición</label>
                    <select id="position-type">
                        <option value="long">Long (Compra)</option>
                        <option value="short">Short (Venta)</option>
                    </select>
                </div>
            </div>

            <div class="section">
                <h2>💰 Entradas de Posición</h2>

                <div class="collapsible-info">
                    <div class="collapsible-header" onclick="toggleInfo()">
                        <span>📌 ¿Cómo funciona el cálculo de la posición?</span>
                        <span class="arrow">▼</span>
                    </div>
                    <div class="collapsible-content" id="info-content">
                        El "Precio de Entrada" es el precio actual de la moneda/cripto al momento de tu compra. 
                        Con apalancamiento, controlas más valor del que inviertes.
                        <br><br>
                        <strong>Ejemplo con $100 a $1000 por token:</strong>
                        <br>• Con 1x: Controlas $100 → Compras 0.1 tokens
                        <br>• Con 5x: Controlas $500 → Compras 0.5 tokens
                        <br>• Con 10x: Controlas $1000 → Compras 1.0 token
                    </div>
                </div>

                <div class="entries-container" id="entries-container">
                    <div class="entry-card" data-entry="1">
                        <h3>Entrada 1 (Principal)</h3>
                        <div class="input-group">
                            <label>Capital Invertido (USD)</label>
                            <input type="number" class="entry-amount" value="1000" step="0.01" min="0">
                        </div>
                        <div class="input-group">
                            <label>Precio de Entrada de la Moneda (USD)</label>
                            <input type="number" class="entry-price" value="50000" step="0.01" min="0">
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="addEntry()">+ Agregar Recompra</button>
                <button class="btn btn-secondary" onclick="removeLastEntry()">- Eliminar Última</button>
            </div>

            <div class="section">
                <h2>🎯 Proyecciones Personalizadas</h2>
                <p style="color: #a1a1aa; font-size: 13px; margin-bottom: 15px;">
                    Ingresa hasta 3 porcentajes personalizados para calcular escenarios específicos
                </p>
                <div class="custom-percentages">
                    <div>
                        <label>Porcentaje 1 (%)</label>
                        <input type="number" id="custom-percent-1" placeholder="Ej: 50" step="1">
                    </div>
                    <div>
                        <label>Porcentaje 2 (%)</label>
                        <input type="number" id="custom-percent-2" placeholder="Ej: -45" step="1">
                    </div>
                    <div>
                        <label>Porcentaje 3 (%)</label>
                        <input type="number" id="custom-percent-3" placeholder="Ej: 120" step="1">
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="calculate()" style="font-size: 16px; padding: 15px 40px;">
                    🚀 CALCULAR POSICIÓN
                </button>
            </div>

            <div class="section hidden" id="results-section">
                <h2>📈 Resultados de la Posición</h2>

                <div class="results">
                    <div class="result-card">
                        <h3>Precio Promedio</h3>
                        <div class="value" id="avg-price">-</div>
                        <div class="subvalue">Precio ponderado de todas las entradas</div>
                    </div>
                    <div class="result-card">
                        <h3>Primera Entrada</h3>
                        <div class="value" id="first-entry-price">-</div>
                        <div class="subvalue">Precio de tu entrada inicial</div>
                    </div>
                    <div class="result-card optimal">
                        <h3>🎯 Apalancamiento Óptimo</h3>
                        <div class="value" id="optimal-leverage-display">-</div>
                        <div class="subvalue">SL = Liquidación con este leverage</div>
                    </div>
                    <div class="result-card">
                        <h3>Tamaño Posición</h3>
                        <div class="value" id="position-size">-</div>
                        <div class="subvalue">Total de tokens controlados con leverage</div>
                    </div>
                    <div class="result-card">
                        <h3>Valor Apalancado</h3>
                        <div class="value" id="notional-value">-</div>
                        <div class="subvalue">Valor total de la posición</div>
                    </div>
                    <div class="result-card">
                        <h3>Margen Total</h3>
                        <div class="value" id="total-margin">-</div>
                        <div class="subvalue">Capital total invertido (tu dinero)</div>
                    </div>
                    <div class="result-card">
                        <h3>Precio Liquidación</h3>
                        <div class="value" id="liquidation-price">-</div>
                        <div class="subvalue">Precio de liquidación estimado</div>
                    </div>
                    <div class="result-card">
                        <h3>Stop Loss</h3>
                        <div class="value" id="stop-loss-price">-</div>
                        <div class="subvalue">Precio de stop loss sugerido</div>
                    </div>
                    <div class="result-card loss-card">
                        <h3>💸 Pérdida en SL</h3>
                        <div class="value loss-value" id="sl-loss-usd">-</div>
                        <div class="subvalue">Pérdida en USD si se activa el SL</div>
                    </div>
                </div>

                <div id="liquidation-warning"></div>

                <h2 style="margin-top: 30px;">📉 Tabla de Proyección</h2>
                <p style="color: #a1a1aa; font-size: 14px; margin-bottom: 10px;">
                    💡 <em>Pasa el mouse sobre los títulos de las columnas para ver su explicación</em>
                </p>
                <div style="overflow-x: auto;">
                    <table id="projection-table">
                        <thead>
                            <tr>
                                <th><div class="tooltip-wrapper" onmouseenter="showTooltip(event, 'Porcentaje de cambio en el precio desde tu precio promedio')" onmouseleave="hideTooltip()">Mov. Promedio</div></th>
                                <th><div class="tooltip-wrapper" onmouseenter="showTooltip(event, 'Porcentaje de cambio desde tu PRIMERA entrada')" onmouseleave="hideTooltip()">Mov. 1ra Entrada</div></th>
                                <th><div class="tooltip-wrapper" onmouseenter="showTooltip(event, 'Precio proyectado de la moneda')" onmouseleave="hideTooltip()">Precio</div></th>
                                <th><div class="tooltip-wrapper" onmouseenter="showTooltip(event, 'Tu ganancia o pérdida REAL en USD')" onmouseleave="hideTooltip()">PnL (USD)</div></th>
                                <th><div class="tooltip-wrapper" onmouseenter="showTooltip(event, 'ROI = Movimiento del precio sin apalancamiento')" onmouseleave="hideTooltip()">ROI (%)</div></th>
                                <th><div class="tooltip-wrapper" onmouseenter="showTooltip(event, 'ROE = Tu ganancia real sobre TU dinero con apalancamiento')" onmouseleave="hideTooltip()">ROE (%)</div></th>
                                <th><div class="tooltip-wrapper" onmouseenter="showTooltip(event, 'Estado de tu posición')" onmouseleave="hideTooltip()">Estado</div></th>
                            </tr>
                        </thead>
                        <tbody id="projection-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB CONTENT: CALCULADORA CLÁSICA -->
        <div id="classic-tab" class="tab-content">
            <div class="classic-calc-container">
                <h2>Calculadora de Posiciones SL V3</h2>

                <div class="classic-input-group">
                    <label>SLB (de la cuenta):</label>
                    <input type="number" id="classic-slb" value="2" step="0.1">
                </div>

                <div class="classic-input-group">
                    <label>SLT (del gráfico):</label>
                    <input type="number" id="classic-slt" value="12" step="0.1">
                </div>

                <div class="classic-input-group">
                    <label>Cuenta:</label>
                    <input type="number" id="classic-account" value="3500" step="0.01">
                </div>

                <div class="classic-input-group">
                    <label>Palanca:</label>
                    <input type="number" id="classic-leverage" value="5" step="1" min="1">
                </div>

                <div class="classic-input-group">
                    <label>PrecioLote:</label>
                    <input type="number" id="classic-price" value="6.617" step="0.001">
                </div>

                <button class="classic-btn" onclick="calculateClassic()">
                    📊 Calcular
                </button>

                <div class="classic-results hidden" id="classic-results">
                    <div class="classic-result-item">
                        <strong>El Margin es:</strong> 
                        <span class="classic-result-value classic-result-green" id="classic-margin">-</span>
                    </div>
                    <div class="classic-result-item">
                        <strong>El margin apalancado es:</strong> 
                        <span class="classic-result-value classic-result-green" id="classic-margin-apalancado">-</span>
                    </div>
                    <div class="classic-result-item">
                        <strong>El SL de la cuenta es de:</strong> 
                        <span class="classic-result-value classic-result-red" id="classic-sl-account">-</span>
                    </div>
                    <div class="classic-result-item">
                        <strong>El tamaño de posición es:</strong> 
                        <span class="classic-result-value classic-result-yellow" id="classic-position-size">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FAB: Calculadora Clásica Flotante -->
    <button class="fab-calculator" onclick="openFloatingCalc()" title="Abrir calculadora clásica flotante">
        🧮
    </button>

    <!-- FAB: Historial -->
    <button class="fab-history" onclick="openHistoryModal()" id="fab-history">
        🕐
        <span class="fab-badge hidden" id="history-count">0</span>
    </button>

    <!-- Modal Flotante: Calculadora Clásica -->
    <div class="modal-backdrop" id="floating-backdrop" onclick="closeFloatingCalc()"></div>
    <div class="floating-modal" id="floating-modal">
        <div class="floating-modal-header" id="floating-header">
            <h3>🧮 Calculadora SL Clásica</h3>
            <button class="btn-close-floating" onclick="closeFloatingCalc()">✕</button>
        </div>
        <div class="floating-modal-body">
            <div class="classic-calc-container" style="background: transparent; padding: 0;">
                <div class="classic-input-group">
                    <label>SLB (de la cuenta):</label>
                    <input type="number" id="floating-slb" value="2" step="0.1">
                </div>

                <div class="classic-input-group">
                    <label>SLT (del gráfico):</label>
                    <input type="number" id="floating-slt" value="12" step="0.1">
                </div>

                <div class="classic-input-group">
                    <label>Cuenta:</label>
                    <input type="number" id="floating-account" value="3500" step="0.01">
                </div>

                <div class="classic-input-group">
                    <label>Palanca:</label>
                    <input type="number" id="floating-leverage" value="5" step="1" min="1">
                </div>

                <div class="classic-input-group">
                    <label>PrecioLote:</label>
                    <input type="number" id="floating-price" value="6.617" step="0.001">
                </div>

                <button class="classic-btn" onclick="calculateFloating()">
                    📊 Calcular
                </button>

                <div class="classic-results hidden" id="floating-results">
                    <div class="classic-result-item">
                        <strong>El Margin es:</strong> 
                        <span class="classic-result-value classic-result-green" id="floating-margin">-</span>
                    </div>
                    <div class="classic-result-item">
                        <strong>El margin apalancado es:</strong> 
                        <span class="classic-result-value classic-result-green" id="floating-margin-apalancado">-</span>
                    </div>
                    <div class="classic-result-item">
                        <strong>El SL de la cuenta es de:</strong> 
                        <span class="classic-result-value classic-result-red" id="floating-sl-account">-</span>
                    </div>
                    <div class="classic-result-item">
                        <strong>El tamaño de posición es:</strong> 
                        <span class="classic-result-value classic-result-yellow" id="floating-position-size">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Historial -->
    <div class="history-modal" id="history-modal" onclick="closeHistoryModal(event)">
        <div class="history-modal-content" onclick="event.stopPropagation()">
            <div class="history-modal-header">
                <h2>🕐 Historial de Cálculos</h2>
                <button class="btn-close-modal" onclick="closeHistoryModal()">✕</button>
            </div>
            <div class="history-modal-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <p style="color: #a1a1aa; font-size: 13px;">
                        Últimos cálculos guardados automáticamente
                    </p>
                    <button class="btn btn-secondary" onclick="clearHistory()" style="margin: 0; padding: 8px 16px; font-size: 12px;">
                        🗑️ Limpiar Todo
                    </button>
                </div>

                <div class="compare-section hidden" id="compare-section">
                    <h2 style="color: #a78bfa; margin-bottom: 15px; font-size: 20px; border: none; padding: 0;">⚖️ Comparación</h2>
                    <p style="color: #a1a1aa; font-size: 13px; margin-bottom: 15px;">
                        Selecciona hasta 2 cálculos para compararlos
                    </p>
                    <div class="compare-grid" id="compare-grid"></div>
                </div>

                <div class="history-container" id="history-container">
                    <div class="empty-history">
                        <div class="empty-history-icon">📭</div>
                        <p>No hay cálculos guardados aún</p>
                        <p style="font-size: 12px; margin-top: 8px;">Los cálculos se guardarán automáticamente</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="global-tooltip" class="tooltip-text"></div>

    <script>
        // ===== SISTEMA DE TABS =====
        function switchTab(tab) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

            // Mostrar el tab seleccionado
            if (tab === 'advanced') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('advanced-tab').classList.add('active');
            } else if (tab === 'classic') {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('classic-tab').classList.add('active');
            }
        }

        // ===== CALCULADORA CLÁSICA =====
        function calculateClassic() {
            const slb = parseFloat(document.getElementById('classic-slb').value);
            const slt = parseFloat(document.getElementById('classic-slt').value);
            const account = parseFloat(document.getElementById('classic-account').value);
            const leverage = parseFloat(document.getElementById('classic-leverage').value);
            const price = parseFloat(document.getElementById('classic-price').value);

            // Cálculos correctos
            const margin = (((slb / slt) * account) / leverage);
            const marginApalancado = margin * leverage;
            const slAccount = slb * account / 100;
            const positionSize = marginApalancado / price;

            // Mostrar resultados
            document.getElementById('classic-margin').textContent = margin.toFixed(2);
            document.getElementById('classic-margin-apalancado').textContent = marginApalancado.toFixed(2);
            document.getElementById('classic-sl-account').textContent = slAccount.toFixed(2) + ' $';
            document.getElementById('classic-position-size').textContent = positionSize.toFixed(8);

            document.getElementById('classic-results').classList.remove('hidden');
        }

        function calculateFloating() {
            const slb = parseFloat(document.getElementById('floating-slb').value);
            const slt = parseFloat(document.getElementById('floating-slt').value);
            const account = parseFloat(document.getElementById('floating-account').value);
            const leverage = parseFloat(document.getElementById('floating-leverage').value);
            const price = parseFloat(document.getElementById('floating-price').value);

            // Cálculos correctos
            const margin = (((slb / slt) * account) / leverage);
            const marginApalancado = margin * leverage;
            const slAccount = slb * account / 100;
            const positionSize = marginApalancado / price;

            // Mostrar resultados
            document.getElementById('floating-margin').textContent = margin.toFixed(2);
            document.getElementById('floating-margin-apalancado').textContent = marginApalancado.toFixed(2);
            document.getElementById('floating-sl-account').textContent = slAccount.toFixed(2) + ' $';
            document.getElementById('floating-position-size').textContent = positionSize.toFixed(8);

            document.getElementById('floating-results').classList.remove('hidden');
        }

        // ===== MODAL FLOTANTE =====
        function openFloatingCalc() {
            document.getElementById('floating-modal').classList.add('show');
            document.getElementById('floating-backdrop').classList.add('show');
        }

        function closeFloatingCalc() {
            document.getElementById('floating-modal').classList.remove('show');
            document.getElementById('floating-backdrop').classList.remove('show');
        }

        // Hacer draggable el modal flotante
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;

        const floatingModal = document.getElementById('floating-modal');
        const floatingHeader = document.getElementById('floating-header');

        floatingHeader.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);

        function dragStart(e) {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;

            if (e.target === floatingHeader || floatingHeader.contains(e.target)) {
                isDragging = true;
            }
        }

        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;

                xOffset = currentX;
                yOffset = currentY;

                setTranslate(currentX, currentY, floatingModal);
            }
        }

        function dragEnd(e) {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
        }

        function setTranslate(xPos, yPos, el) {
            el.style.transform = 'translate(' + (xPos - window.innerWidth/2 + el.offsetWidth/2) + 'px, ' + (yPos - window.innerHeight/2 + el.offsetHeight/2) + 'px)';
        }

        // ===== CALCULADORA AVANZADA =====
        let entryCount = 1;
        const tooltip = document.getElementById('global-tooltip');
        let firstEntryPrice = 0;
        let optimalLeverage = 0;
        let calculationHistory = [];
        let selectedForComparison = [];
        let lastCalculationHash = null;
        const MAX_HISTORY = 10;

        // Convertir nombre de moneda a mayúsculas en tiempo real
        document.getElementById('coin-name').addEventListener('input', function(e) {
            this.value = this.value.toUpperCase();
        });

        function generateCalculationHash(data) {
            return JSON.stringify({
                coinName: data.coinName,
                leverage: data.leverage,
                stopLoss: data.stopLoss,
                positionType: data.positionType,
                entries: data.entries
            });
        }

        function openHistoryModal() {
            document.getElementById('history-modal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeHistoryModal(event) {
            if (!event || event.target.id === 'history-modal') {
                document.getElementById('history-modal').classList.remove('show');
                document.body.style.overflow = 'auto';
            }
        }

        function updateHistoryBadge() {
            const badge = document.getElementById('history-count');
            if (calculationHistory.length > 0) {
                badge.textContent = calculationHistory.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function loadHistory() {
            const saved = localStorage.getItem('tradingHistory');
            if (saved) {
                calculationHistory = JSON.parse(saved);
                renderHistory();
                updateHistoryBadge();
            }
        }

        function saveHistory() {
            localStorage.setItem('tradingHistory', JSON.stringify(calculationHistory));
            updateHistoryBadge();
        }

        function renderHistory() {
            const container = document.getElementById('history-container');

            if (calculationHistory.length === 0) {
                container.innerHTML = '<div class="empty-history"><div class="empty-history-icon">📭</div><p>No hay cálculos guardados aún</p><p style="font-size: 12px; margin-top: 8px;">Los cálculos se guardarán automáticamente</p></div>';
                return;
            }

            container.innerHTML = '';
            calculationHistory.forEach((calc, index) => {
                const card = document.createElement('div');
                card.className = 'history-card';
                if (selectedForComparison.includes(index)) {
                    card.classList.add('selected');
                }

                const time = new Date(calc.timestamp).toLocaleString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                card.innerHTML = '<div class="history-header"><div><div class="history-title">Cálculo #' + (calculationHistory.length - index) + '</div><div class="history-time">' + time + '</div></div><div class="history-coin">' + (calc.coinName || 'N/A') + '</div></div><div class="history-details"><div class="history-item"><span class="label">Leverage:</span><span class="value">' + calc.leverage + 'x</span></div><div class="history-item"><span class="label">Capital:</span><span class="value">$' + calc.totalInvested.toFixed(2) + '</span></div><div class="history-item"><span class="label">Precio Prom:</span><span class="value">$' + calc.avgPrice.toFixed(2) + '</span></div><div class="history-item"><span class="label">Stop Loss:</span><span class="value">' + calc.stopLoss + '%</span></div><div class="history-item"><span class="label">Pérdida SL:</span><span class="value loss">-$' + calc.slLoss.toFixed(2) + '</span></div></div><div class="history-actions"><button class="btn-mini load" onclick="loadCalculation(' + index + ')">📂 Cargar</button><button class="btn-mini" onclick="toggleCompare(' + index + ')">⚖️ Comparar</button><button class="btn-mini delete" onclick="deleteCalculation(' + index + ')">🗑️</button></div>';

                container.appendChild(card);
            });
        }

        function addToHistory(calculationData) {
            const hash = generateCalculationHash(calculationData);

            if (hash === lastCalculationHash) {
                return;
            }

            lastCalculationHash = hash;

            calculationHistory.unshift({
                ...calculationData,
                timestamp: Date.now()
            });

            if (calculationHistory.length > MAX_HISTORY) {
                calculationHistory = calculationHistory.slice(0, MAX_HISTORY);
            }

            saveHistory();
            renderHistory();
        }

        function loadCalculation(index) {
            const calc = calculationHistory[index];

            // Cambiar a la pestaña avanzada
            switchTab('advanced');

            document.getElementById('coin-name').value = calc.coinName || '';
            document.getElementById('leverage').value = calc.leverage;
            document.getElementById('stop-loss-percent').value = calc.stopLoss;
            document.getElementById('position-type').value = calc.positionType;

            const container = document.getElementById('entries-container');
            container.innerHTML = '';
            entryCount = 0;

            calc.entries.forEach((entry, i) => {
                if (i === 0) {
                    entryCount = 1;
                    container.innerHTML = '<div class="entry-card" data-entry="1"><h3>Entrada 1 (Principal)</h3><div class="input-group"><label>Capital Invertido (USD)</label><input type="number" class="entry-amount" value="' + entry.amount + '" step="0.01" min="0"></div><div class="input-group"><label>Precio de Entrada de la Moneda (USD)</label><input type="number" class="entry-price" value="' + entry.price + '" step="0.01" min="0"></div></div>';
                } else {
                    addEntry();
                    const lastCard = container.lastElementChild;
                    lastCard.querySelector('.entry-amount').value = entry.amount;
                    lastCard.querySelector('.entry-price').value = entry.price;
                }
            });

            closeHistoryModal();
            alert('✅ Cálculo cargado exitosamente');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteCalculation(index) {
            if (confirm('¿Estás seguro de eliminar este cálculo?')) {
                calculationHistory.splice(index, 1);
                selectedForComparison = selectedForComparison.filter(i => i !== index).map(i => i > index ? i - 1 : i);
                saveHistory();
                renderHistory();
                updateComparison();
            }
        }

        function clearHistory() {
            if (confirm('¿Estás seguro de eliminar todo el historial?')) {
                calculationHistory = [];
                selectedForComparison = [];
                lastCalculationHash = null;
                saveHistory();
                renderHistory();
                updateComparison();
            }
        }

        function toggleCompare(index) {
            const idx = selectedForComparison.indexOf(index);
            if (idx > -1) {
                selectedForComparison.splice(idx, 1);
            } else {
                if (selectedForComparison.length >= 2) {
                    alert('Solo puedes comparar 2 cálculos a la vez');
                    return;
                }
                selectedForComparison.push(index);
            }
            renderHistory();
            updateComparison();
        }

        function updateComparison() {
            const section = document.getElementById('compare-section');
            const grid = document.getElementById('compare-grid');

            if (selectedForComparison.length < 2) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            grid.innerHTML = '';

            selectedForComparison.forEach((index, i) => {
                const calc = calculationHistory[index];
                const card = document.createElement('div');
                card.className = 'compare-card';

                const roe10 = ((10 / 100) * calc.leverage) * 100;
                const pnl10 = (calc.avgPrice * 0.1) * calc.positionSize;

                const betterLeverage = i === 1 && calc.leverage > calculationHistory[selectedForComparison[0]].leverage;
                const betterROE = i === 1 && roe10 > ((10 / 100) * calculationHistory[selectedForComparison[0]].leverage) * 100;
                const lowerRisk = i === 1 && calc.slLoss < calculationHistory[selectedForComparison[0]].slLoss;

                card.innerHTML = '<h4>' + (calc.coinName || 'N/A') + ' - Cálculo #' + (calculationHistory.length - index) + '</h4><div class="compare-item"><span class="label">Leverage:</span><span class="value">' + calc.leverage + 'x ' + (betterLeverage ? '<span class="winner-indicator">MAYOR</span>' : '') + '</span></div><div class="compare-item"><span class="label">Capital:</span><span class="value">$' + calc.totalInvested.toFixed(2) + '</span></div><div class="compare-item"><span class="label">Precio Prom:</span><span class="value">$' + calc.avgPrice.toFixed(2) + '</span></div><div class="compare-item"><span class="label">Stop Loss:</span><span class="value">' + calc.stopLoss + '%</span></div><div class="compare-item"><span class="label">Pérdida SL:</span><span class="value loss">-$' + calc.slLoss.toFixed(2) + ' ' + (lowerRisk ? '<span class="winner-indicator">MENOR RIESGO</span>' : '') + '</span></div><div class="compare-item"><span class="label">ROE (+10%):</span><span class="value profit">' + Math.round(roe10) + '% ' + (betterROE ? '<span class="winner-indicator">MEJOR</span>' : '') + '</span></div><div class="compare-item"><span class="label">PnL (+10%):</span><span class="value profit">$' + pnl10.toFixed(2) + '</span></div>';
                grid.appendChild(card);
            });
        }

        function showTooltip(event, text) {
            tooltip.textContent = text;
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';

            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = (rect.left + rect.width / 2 - 160) + 'px';
            tooltip.style.top = (rect.top - 80) + 'px';
        }

        function hideTooltip() {
            tooltip.style.visibility = 'hidden';
            tooltip.style.opacity = '0';
        }

        function toggleInfo() {
            const content = document.getElementById('info-content');
            const header = document.querySelector('.collapsible-header');

            if (content.classList.contains('show')) {
                content.classList.remove('show');
                header.classList.remove('active');
            } else {
                content.classList.add('show');
                header.classList.add('active');
            }
        }

        function addEntry() {
            entryCount++;
            const container = document.getElementById('entries-container');
            const entryCard = document.createElement('div');
            entryCard.className = 'entry-card';
            entryCard.setAttribute('data-entry', entryCount);
            entryCard.innerHTML = '<h3>Recompra ' + (entryCount - 1) + '</h3><div class="input-group"><label>Capital Invertido (USD)</label><input type="number" class="entry-amount" value="1000" step="0.01" min="0"></div><div class="input-group"><label>Precio de Entrada de la Moneda (USD)</label><input type="number" class="entry-price" value="48000" step="0.01" min="0"></div>';
            container.appendChild(entryCard);
        }

        function removeLastEntry() {
            if (entryCount > 1) {
                const container = document.getElementById('entries-container');
                container.removeChild(container.lastElementChild);
                entryCount--;
            }
        }

        function calculate() {
            const coinName = document.getElementById('coin-name').value.trim().toUpperCase() || 'N/A';
            const positionType = document.getElementById('position-type').value;
            const leverage = parseFloat(document.getElementById('leverage').value);
            const stopLossPercent = parseFloat(document.getElementById('stop-loss-percent').value);

            const entries = [];
            const entryCards = document.querySelectorAll('.entry-card');

            entryCards.forEach(card => {
                const price = parseFloat(card.querySelector('.entry-price').value);
                const amount = parseFloat(card.querySelector('.entry-amount').value);
                if (price > 0 && amount > 0) {
                    entries.push({ price, amount });
                }
            });

            if (entries.length === 0) {
                alert('Por favor ingresa al menos una entrada válida');
                return;
            }

            optimalLeverage = 100 / stopLossPercent;
            document.getElementById('optimal-leverage-display').textContent = Math.round(optimalLeverage) + 'x';

            firstEntryPrice = entries[0].price;

            let totalInvested = 0;
            let totalTokens = 0;

            entries.forEach(entry => {
                totalInvested += entry.amount;
                totalTokens += (entry.amount * leverage) / entry.price;
            });

            const avgPrice = (totalInvested * leverage) / totalTokens;
            const positionSize = totalTokens;
            const notionalValue = positionSize * avgPrice;

            let liquidationPrice;
            if (positionType === 'long') {
                liquidationPrice = avgPrice * (1 - (1 / leverage));
            } else {
                liquidationPrice = avgPrice * (1 + (1 / leverage));
            }

            let stopLossPrice;
            if (positionType === 'long') {
                stopLossPrice = avgPrice * (1 - stopLossPercent / 100);
            } else {
                stopLossPrice = avgPrice * (1 + stopLossPercent / 100);
            }

            const priceDiffSL = stopLossPrice - avgPrice;
            const slLossUSD = Math.abs(priceDiffSL * positionSize);

            addToHistory({
                coinName,
                leverage,
                stopLoss: stopLossPercent,
                positionType,
                entries,
                totalInvested,
                avgPrice,
                positionSize,
                slLoss: slLossUSD
            });

            document.getElementById('avg-price').textContent = '$' + avgPrice.toFixed(2);
            document.getElementById('first-entry-price').textContent = '$' + firstEntryPrice.toFixed(2);
            document.getElementById('position-size').textContent = positionSize.toFixed(6);
            document.getElementById('notional-value').textContent = '$' + notionalValue.toFixed(2);
            document.getElementById('total-margin').textContent = '$' + totalInvested.toFixed(2);
            document.getElementById('liquidation-price').textContent = '$' + liquidationPrice.toFixed(2);
            document.getElementById('stop-loss-price').textContent = '$' + stopLossPrice.toFixed(2);
            document.getElementById('sl-loss-usd').textContent = '-$' + slLossUSD.toFixed(2);

            const distanceToLiq = Math.abs((liquidationPrice - avgPrice) / avgPrice * 100);
            const warningDiv = document.getElementById('liquidation-warning');

            if (distanceToLiq < 15) {
                warningDiv.innerHTML = '<div class="alert">⚠️ <strong>ALERTA:</strong> El precio de liquidación está muy cerca (' + distanceToLiq.toFixed(0) + '% de distancia). Considera reducir el apalancamiento o aumentar el margen.</div>';
            } else if (distanceToLiq < 30) {
                warningDiv.innerHTML = '<div class="warning">⚡ <strong>Precaución:</strong> Distancia a liquidación: ' + distanceToLiq.toFixed(0) + '%. Mantén un seguimiento cercano de tu posición.</div>';
            } else {
                warningDiv.innerHTML = '';
            }

            const projectionBody = document.getElementById('projection-body');
            projectionBody.innerHTML = '';

            const percentages = [30, 25, 20, 15, 10, 5, 0, -5, -10, -15, -20, -25, -30];

            const customPercentages = [];
            for (let i = 1; i <= 3; i++) {
                const value = parseFloat(document.getElementById('custom-percent-' + i).value);
                if (!isNaN(value)) {
                    customPercentages.push({ percent: value, isCustom: true });
                }
            }

            const allPercentages = [
                ...percentages.map(p => ({ percent: p, isCustom: false })),
                ...customPercentages
            ].sort((a, b) => b.percent - a.percent);

            allPercentages.forEach(item => {
                const percent = item.percent;
                const isCustom = item.isCustom;

                let newPrice;
                if (positionType === 'long') {
                    newPrice = avgPrice * (1 + percent / 100);
                } else {
                    newPrice = avgPrice * (1 - percent / 100);
                }

                let moveFromFirst;
                if (positionType === 'long') {
                    moveFromFirst = ((newPrice - firstEntryPrice) / firstEntryPrice) * 100;
                } else {
                    moveFromFirst = ((firstEntryPrice - newPrice) / firstEntryPrice) * 100;
                }

                const priceDiff = newPrice - avgPrice;
                const pnl = priceDiff * positionSize;
                const roi = (priceDiff / avgPrice) * 100;
                const roe = (pnl / totalInvested) * 100;

                const distToLiqFromPrice = Math.abs((newPrice - liquidationPrice) / liquidationPrice * 100);

                let status = '';
                let rowClass = '';
                let zoneIndicator = '';

                if (positionType === 'long') {
                    if (newPrice <= liquidationPrice) {
                        status = '💀 LIQUIDADO';
                        rowClass = 'row-critical';
                    } else if (newPrice <= stopLossPrice) {
                        status = '🛑 Stop Loss';
                        rowClass = 'row-danger-zone';
                    } else if (pnl > 0) {
                        if (roe > 50) {
                            rowClass = 'row-excellent';
                            zoneIndicator = '<span class="zone-indicator zone-safe">ROE > 50%</span>';
                        } else if (roe > 20) {
                            rowClass = 'row-good';
                            zoneIndicator = '<span class="zone-indicator zone-safe">ROE > 20%</span>';
                        }
                        status = '✅ En ganancia' + zoneIndicator;
                    } else if (pnl < 0) {
                        if (distToLiqFromPrice < 5) {
                            rowClass = 'row-critical';
                            zoneIndicator = '<span class="zone-indicator zone-danger">⚠️ CRÍTICO</span>';
                        } else if (distToLiqFromPrice < 15) {
                            rowClass = 'row-danger-zone';
                            zoneIndicator = '<span class="zone-indicator zone-danger">Cerca liquidación</span>';
                        }
                        status = '⚠️ En pérdida' + zoneIndicator;
                    } else {
                        status = '➡️ Punto de entrada';
                    }
                } else {
                    if (newPrice >= liquidationPrice) {
                        status = '💀 LIQUIDADO';
                        rowClass = 'row-critical';
                    } else if (newPrice >= stopLossPrice) {
                        status = '🛑 Stop Loss';
                        rowClass = 'row-danger-zone';
                    } else if (pnl > 0) {
                        if (roe > 50) {
                            rowClass = 'row-excellent';
                            zoneIndicator = '<span class="zone-indicator zone-safe">ROE > 50%</span>';
                        } else if (roe > 20) {
                            rowClass = 'row-good';
                            zoneIndicator = '<span class="zone-indicator zone-safe">ROE > 20%</span>';
                        }
                        status = '✅ En ganancia' + zoneIndicator;
                    } else if (pnl < 0) {
                        if (distToLiqFromPrice < 5) {
                            rowClass = 'row-critical';
                            zoneIndicator = '<span class="zone-indicator zone-danger">⚠️ CRÍTICO</span>';
                        } else if (distToLiqFromPrice < 15) {
                            rowClass = 'row-danger-zone';
                            zoneIndicator = '<span class="zone-indicator zone-danger">Cerca liquidación</span>';
                        }
                        status = '⚠️ En pérdida' + zoneIndicator;
                    } else {
                        status = '➡️ Punto de entrada';
                    }
                }

                if (isCustom && !rowClass) {
                    rowClass = 'custom-row';
                }

                const row = document.createElement('tr');
                if (rowClass) {
                    row.className = rowClass;
                }
                row.innerHTML = '<td><strong>' + (percent > 0 ? '+' : '') + percent + '%</strong></td><td><strong>' + (moveFromFirst > 0 ? '+' : '') + Math.round(moveFromFirst) + '%</strong></td><td>$' + newPrice.toFixed(2) + '</td><td class="' + (pnl >= 0 ? 'profit' : 'loss') + '">$' + pnl.toFixed(2) + '</td><td class="' + (roi >= 0 ? 'profit' : 'loss') + '">' + Math.round(roi) + '%</td><td class="' + (roe >= 0 ? 'profit' : 'loss') + '">' + Math.round(roe) + '%</td><td>' + status + '</td>';
                projectionBody.appendChild(row);
            });

            document.getElementById('results-section').classList.remove('hidden');
            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
        }

        loadHistory();

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeHistoryModal();
                closeFloatingCalc();
            }
        });
                // ===== CÁLCULO AUTOMÁTICO PARA CALCULADORA CLÁSICA (TAB) =====
        document.getElementById('classic-slb').addEventListener('input', calculateClassic);
        document.getElementById('classic-slt').addEventListener('input', calculateClassic);
        document.getElementById('classic-account').addEventListener('input', calculateClassic);
        document.getElementById('classic-leverage').addEventListener('input', calculateClassic);
        document.getElementById('classic-price').addEventListener('input', calculateClassic);

        // ===== CÁLCULO AUTOMÁTICO PARA CALCULADORA FLOTANTE =====
        document.getElementById('floating-slb').addEventListener('input', calculateFloating);
        document.getElementById('floating-slt').addEventListener('input', calculateFloating);
        document.getElementById('floating-account').addEventListener('input', calculateFloating);
        document.getElementById('floating-leverage').addEventListener('input', calculateFloating);
        document.getElementById('floating-price').addEventListener('input', calculateFloating);

        // Calcular automáticamente al cargar
        calculateClassic();
        calculateFloating();

    </script>
</body>
</html>